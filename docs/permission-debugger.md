# 权限调试功能

## 功能概述

权限调试功能允许开发者在不切换用户账号的情况下，实时测试不同权限组合对页面功能的影响。这是一个开发和测试工具，仅应在开发环境中使用。

## 使用方法

### 1. 打开调试工具

- 登录系统后，点击右下角的绿色"调试工具"悬浮按钮
- 在弹出的对话框中选择"权限调试"选项卡

### 2. 权限状态说明

权限调试器中的每个权限有三种状态：

- 🟢 **绿色（原始权限）**：用户原本就有的权限
- 🔵 **蓝色（调试启用）**：通过调试工具临时启用的权限
- ⚪ **灰色（禁用）**：被禁用的权限（包括原始权限被临时禁用）

### 3. 权限操作

#### 启用权限
- 点击灰色的权限复选框来启用该权限
- 权限会变为蓝色状态，页面功能立即更新

#### 禁用权限
- 点击绿色或蓝色的权限复选框来禁用该权限
- 权限会变为灰色状态，相关功能会从页面中隐藏

#### 重置权限
- 点击右上角的"重置权限"按钮
- 所有权限覆盖会被清除，恢复到用户的原始权限状态

## 技术实现

### 权限覆盖机制

```typescript
// AuthContext 中的权限覆盖逻辑
const baseRights = user ? [...user.rights, ...user.operation_right] : [];

const rights = baseRights.filter(right => {
  // 如果有覆盖设置，使用覆盖设置
  if (permissionOverrides.hasOwnProperty(right)) {
    return permissionOverrides[right];
  }
  // 否则使用原始权限
  return true;
}).concat(
  // 添加通过覆盖启用的新权限
  Object.keys(permissionOverrides).filter(right => 
    permissionOverrides[right] && !baseRights.includes(right)
  )
);
```

### 调试 API

调试功能提供了以下方法：

- `setPermissionOverride(permission, enabled)` - 设置权限覆盖
- `clearPermissionOverrides()` - 清除所有权限覆盖
- `getPermissionOverrides()` - 获取当前覆盖设置
- `getBaseRights()` - 获取用户原始权限

## 实际应用场景

### 1. 菜单功能测试

```typescript
// 测试场景：验证不同权限下的菜单显示
// 1. 禁用 view_staff 权限，检查员工管理菜单是否隐藏
// 2. 启用 edit_staff 权限，检查"添加员工"按钮是否显示
// 3. 启用 delete_staff 权限，检查删除按钮是否可用
```

### 2. 页面功能测试

```typescript
// 测试场景：员工管理页面功能验证
// 1. 仅启用 finance 权限，页面应显示但无操作按钮
// 2. 启用 view_staff 权限，应显示前5个查看功能按钮
// 3. 启用 edit_staff 权限，应显示"禁用账户"按钮
// 4. 启用 delete_staff 权限，应显示"删除账户"按钮
```

### 3. 组合权限测试

```typescript
// 测试场景：权限组合效果
// 1. 同时启用多个权限，验证功能累加效果
// 2. 禁用核心权限，验证依赖功能是否正确隐藏
// 3. 测试权限冲突和优先级
```

## 注意事项

### 安全考虑

1. **仅开发环境使用**：此功能应仅在开发和测试环境中启用
2. **前端权限检查**：权限覆盖仅影响前端显示，不影响后端验证
3. **状态管理**：权限覆盖状态仅存在于当前会话中，刷新页面会重置

### 使用限制

1. **权限范围**：只能测试预定义的权限列表中的权限
2. **实时性**：权限变更会立即影响页面显示，无需刷新
3. **状态持久性**：权限覆盖设置不会保存到服务器

### 最佳实践

1. **测试流程**：
   - 先测试无权限状态
   - 逐步添加权限验证功能显示
   - 测试权限移除后的功能隐藏

2. **调试技巧**：
   - 使用"重置权限"快速回到原始状态
   - 结合菜单调试查看权限对菜单的影响
   - 在不同页面间切换验证权限一致性

3. **验证重点**：
   - 权限检查的准确性
   - UI组件的正确显示/隐藏
   - 用户体验的连贯性

## 权限列表

当前支持调试的权限包括：

### 核心权限
- `core_admin` - 核心管理员

### 员工管理
- `view_staff` - 查看员工
- `edit_staff` - 编辑员工
- `delete_staff` - 删除员工
- `create_staff` - 创建员工

### 学生管理  
- `view_students` - 查看学生
- `edit_students` - 编辑学生
- `delete_students` - 删除学生

### 财务相关
- `finance` - 财务权限
- `sales_person` - 销售人员
- `view_accounting` - 查看账务

### 其他权限
- `view_demo` - Demo页面查看
- `edit_demo` - Demo页面编辑
- `view_dashboard` - 仪表盘查看

更多权限请参考 `src/types/permission.ts` 中的 `COMMON_PERMISSIONS` 定义。

## 故障排除

### 权限不生效
1. 检查权限名称是否正确
2. 确认组件使用了 `useAuth()` Hook
3. 验证权限检查逻辑是否正确

### 页面无响应
1. 尝试重置权限
2. 刷新页面重新开始
3. 检查浏览器控制台错误

### 功能显示异常
1. 检查权限依赖关系
2. 验证组件的权限检查逻辑
3. 确认UI状态更新是否正确 